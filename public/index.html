<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poly Trading - Strategy Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0c0c0f;
            --bg-card: #141419;
            --bg-highlight: #1c1c24;
            --border: #2a2a35;
            --text: #e4e4e7;
            --text-dim: #71717a;
            --green: #22c55e;
            --green-dim: rgba(34, 197, 94, 0.15);
            --red: #ef4444;
            --red-dim: rgba(239, 68, 68, 0.15);
            --yellow: #eab308;
            --yellow-dim: rgba(234, 179, 8, 0.15);
            --blue: #3b82f6;
            --blue-dim: rgba(59, 130, 246, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 24px;
        }

        .mono { font-family: 'IBM Plex Mono', monospace; }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-dim);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* View Tabs */
        .view-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-highlight);
            padding: 4px;
            border-radius: 8px;
        }

        .view-tab {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-dim);
            font-size: 13px;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-tab:hover {
            color: var(--text);
        }

        .view-tab.active {
            background: var(--blue);
            color: white;
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 24px;
        }

        @media (max-width: 1200px) {
            .main-grid { grid-template-columns: 1fr; }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
        }

        /* Market Card */
        .market-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .market-name {
            font-size: 24px;
            font-weight: 700;
        }

        .market-time {
            text-align: right;
        }

        .time-remaining {
            font-size: 32px;
            font-weight: 700;
            font-family: 'IBM Plex Mono', monospace;
        }

        .time-label {
            font-size: 12px;
            color: var(--text-dim);
        }

        /* Price Display */
        .price-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .price-box {
            background: var(--bg-highlight);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .price-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 8px;
        }

        .price-value {
            font-size: 28px;
            font-weight: 700;
            font-family: 'IBM Plex Mono', monospace;
        }

        .price-value.up { color: var(--green); }
        .price-value.down { color: var(--red); }
        .price-value.neutral { color: var(--text); }

        .price-change {
            font-size: 13px;
            margin-top: 4px;
        }

        .price-change.positive { color: var(--green); }
        .price-change.negative { color: var(--red); }

        /* Spot Correlation */
        .correlation-section {
            background: var(--bg-highlight);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .correlation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .correlation-title {
            font-size: 13px;
            font-weight: 600;
        }

        .correlation-bar {
            height: 8px;
            background: var(--bg);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .correlation-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s, background 0.3s;
        }

        .correlation-labels {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-dim);
        }

        /* Trade Signal */
        .signal-box {
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .signal-box.opportunity { background: var(--green-dim); border: 1px solid var(--green); }
        .signal-box.caution { background: var(--yellow-dim); border: 1px solid var(--yellow); }
        .signal-box.wait { background: var(--bg-highlight); border: 1px solid var(--border); }

        .signal-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .signal-text {
            font-size: 18px;
            font-weight: 700;
        }

        .signal-reason {
            font-size: 13px;
            color: var(--text-dim);
            margin-top: 8px;
        }

        /* Strategy Thresholds */
        .threshold-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .threshold-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-highlight);
            border-radius: 8px;
        }

        .threshold-item.active {
            border: 1px solid var(--green);
            background: var(--green-dim);
        }

        .threshold-name {
            font-size: 13px;
            font-weight: 500;
        }

        .threshold-value {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 14px;
            font-weight: 600;
        }

        /* Right Panel */
        .insight-card {
            background: var(--bg-highlight);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .insight-title {
            font-size: 12px;
            color: var(--text-dim);
            margin-bottom: 8px;
        }

        .insight-value {
            font-size: 18px;
            font-weight: 600;
        }

        .insight-detail {
            font-size: 12px;
            color: var(--text-dim);
            margin-top: 4px;
        }

        /* Trade History */
        .trade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .trade-item:last-child { border-bottom: none; }

        .trade-side {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .trade-side.buy { background: var(--green-dim); color: var(--green); }
        .trade-side.sell { background: var(--red-dim); color: var(--red); }

        /* No Data State */
        .no-data {
            text-align: center;
            padding: 40px;
            color: var(--text-dim);
        }

        .no-data-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        /* Market Tabs */
        .market-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .market-tab {
            padding: 8px 16px;
            background: var(--bg-highlight);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .market-tab:hover { border-color: var(--text-dim); }
        .market-tab.active { background: var(--blue-dim); border-color: var(--blue); color: var(--blue); }
        .market-tab.inactive { opacity: 0.5; }

        /* Live indicator */
        .live-value {
            transition: background 0.1s;
        }

        .live-value.flash {
            background: var(--yellow-dim);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä Poly Trading Strategy</h1>
        <div style="display: flex; align-items: center; gap: 16px;">
            <div class="view-tabs">
                <button class="view-tab active" data-view="trading" onclick="switchView('trading')">Trading</button>
                <button class="view-tab" data-view="research" onclick="switchView('research')">Research</button>
            </div>
            <div class="status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Connecting...</span>
                <span class="mono" id="serverTime">--:--:--</span>
            </div>
        </div>
    </div>

    <!-- Research View (hidden by default) -->
    <div id="researchView" style="display: none;">
        <!-- Header Stats -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">Quant Research Engine</div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <span id="researchStatus" style="font-size: 12px; color: var(--text-dim);">Loading...</span>
                    <button onclick="refreshResearch()" style="padding: 6px 12px; background: var(--blue-dim); border: 1px solid var(--blue); border-radius: 6px; color: var(--blue); cursor: pointer; font-size: 12px;">Refresh</button>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px;">
                <div class="insight-card">
                    <div class="insight-title">Ticks Analyzed</div>
                    <div class="insight-value" id="researchTicks">--</div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">Windows Tracked</div>
                    <div class="insight-value" id="researchWindows">--</div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">Strategies Running</div>
                    <div class="insight-value" style="color: var(--blue);">10</div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">Avg Edge Detected</div>
                    <div class="insight-value" id="researchAvgEdge">--</div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">Spot Lag</div>
                    <div class="insight-value" id="researchSpotLag">--</div>
                </div>
            </div>
        </div>

        <!-- Strategy Performance Leaderboard -->
        <div class="card" style="margin-top: 20px;">
            <div class="card-header">
                <div class="card-title">Strategy Performance Leaderboard</div>
                <div style="font-size: 12px; color: var(--text-dim);">Paper trading $100/position</div>
            </div>
            <div id="strategyLeaderboard" style="font-family: 'IBM Plex Mono', monospace;">
                <div style="color: var(--text-dim); padding: 40px; text-align: center;">
                    <div style="font-size: 14px; margin-bottom: 8px;">Waiting for strategy data...</div>
                    <div style="font-size: 12px;">Railway collector saves stats every 60 seconds</div>
                </div>
            </div>
        </div>

        <!-- Key Insights Section -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            <!-- Market Efficiency by Time Phase -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Edge by Window Phase</div>
                </div>
                <p style="font-size: 12px; color: var(--text-dim); margin-bottom: 16px;">
                    When is the market most inefficient? Early = first 5min, Mid = 5-12min, Late = last 3min
                </p>
                <div id="edgeByPhase" style="font-family: 'IBM Plex Mono', monospace; font-size: 13px;">
                    <div style="color: var(--text-dim); text-align: center; padding: 20px;">Loading...</div>
                </div>
            </div>
            
            <!-- Fair Value Analysis -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Fair Value vs Market</div>
                </div>
                <p style="font-size: 12px; color: var(--text-dim); margin-bottom: 16px;">
                    Black-Scholes derived probability vs what the market is pricing
                </p>
                <div id="fairValueAnalysis" style="font-family: 'IBM Plex Mono', monospace; font-size: 13px;">
                    <div style="color: var(--text-dim); text-align: center; padding: 20px;">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Volatility & Regime Analysis -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Volatility Analysis</div>
                </div>
                <p style="font-size: 12px; color: var(--text-dim); margin-bottom: 16px;">
                    Higher spot volatility = more opportunity but harder to predict
                </p>
                <div id="volatilityData" style="font-family: 'IBM Plex Mono', monospace; font-size: 13px;">
                    <div style="color: var(--text-dim); text-align: center; padding: 20px;">Loading...</div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Spot Lag Analysis</div>
                </div>
                <p style="font-size: 12px; color: var(--text-dim); margin-bottom: 16px;">
                    How fast does the market price spot moves? Slower = more alpha opportunity
                </p>
                <div id="spotLagData" style="font-family: 'IBM Plex Mono', monospace; font-size: 13px;">
                    <div style="color: var(--text-dim); text-align: center; padding: 20px;">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Live Market State -->
        <div class="card" style="margin-top: 20px;">
            <div class="card-header">
                <div class="card-title">Live Market State</div>
            </div>
            <div id="cryptoStates" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                <div style="color: var(--text-dim); padding: 20px; text-align: center; grid-column: span 4;">Loading...</div>
            </div>
        </div>

        <!-- Quant Insights / Ideas -->
        <div class="card" style="margin-top: 20px; border-color: var(--blue); border-width: 2px;">
            <div class="card-header">
                <div class="card-title" style="color: var(--blue);">Quant Insights</div>
            </div>
            <div id="quantInsights" style="font-size: 13px; line-height: 1.8;">
                <div style="color: var(--text-dim); text-align: center; padding: 20px;">Analyzing data for insights...</div>
            </div>
        </div>
    </div>

    <!-- Trading View -->
    <div id="tradingView">
    <div class="market-tabs" id="marketTabs">
        <div class="market-tab active" data-crypto="BTC">‚Çø Bitcoin</div>
        <div class="market-tab inactive" data-crypto="ETH">Œû Ethereum</div>
        <div class="market-tab inactive" data-crypto="SOL">‚óé Solana</div>
        <div class="market-tab inactive" data-crypto="XRP">‚úï XRP</div>
    </div>

    <div class="main-grid">
        <div class="left-panel">
            <!-- Main Market Card -->
            <div class="card" id="marketCard">
                <div class="market-header">
                    <div>
                        <div class="market-name" id="marketName">Bitcoin Up/Down</div>
                        <div style="color: var(--text-dim); font-size: 13px; margin-top: 4px;">
                            Window: <span id="windowEpoch" class="mono">--</span>
                        </div>
                    </div>
                    <div class="market-time">
                        <div class="time-remaining" id="timeRemaining">--:--</div>
                        <div class="time-label">remaining</div>
                    </div>
                </div>

                <!-- Price Display -->
                <div class="price-row">
                    <div class="price-box">
                        <div class="price-label">UP Price (Bid/Ask)</div>
                        <div class="price-value up" id="upPrice">--</div>
                        <div class="price-change" id="upBidAsk">-- / --</div>
                    </div>
                    <div class="price-box">
                        <div class="price-label">DOWN Price</div>
                        <div class="price-value down" id="downPrice">--</div>
                        <div class="price-change" id="downBidAsk">-- / --</div>
                    </div>
                    <div class="price-box">
                        <div class="price-label">Spread</div>
                        <div class="price-value neutral" id="spread">--%</div>
                        <div class="price-change">cost to cross</div>
                    </div>
                </div>

                <!-- Spot vs Market Correlation -->
                <div class="correlation-section">
                    <div class="correlation-header">
                        <div class="correlation-title">üìà Spot Price vs Price to Beat</div>
                        <div class="mono" id="spotPrice">$--</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                        <div>
                            <div class="price-label">Price to Beat</div>
                            <div class="mono" style="font-size: 16px; font-weight: 600;" id="priceToBeat">$--</div>
                        </div>
                        <div>
                            <div class="price-label">Spot Œî</div>
                            <div class="mono" style="font-size: 16px; font-weight: 600;" id="spotDelta">+0.000%</div>
                        </div>
                        <div>
                            <div class="price-label">Market Implied</div>
                            <div class="mono" style="font-size: 16px; font-weight: 600;" id="marketImplied">50% up</div>
                        </div>
                    </div>
                    <div style="margin-top: 12px;">
                        <div class="price-label">Direction</div>
                        <div id="impliedDirection" style="font-size: 16px; font-weight: 600; margin-top: 4px;">
                            --
                        </div>
                    </div>
                    <div style="margin-top: 12px;">
                        <div class="price-label">Correlation Insight</div>
                        <div id="correlationInsight" style="font-size: 14px; margin-top: 4px;">
                            Waiting for data...
                        </div>
                    </div>
                </div>

                <!-- Trade Signal -->
                <div class="signal-box wait" id="signalBox">
                    <div class="signal-label">Current Assessment</div>
                    <div class="signal-text" id="signalText">Analyzing...</div>
                    <div class="signal-reason" id="signalReason">Waiting for price data</div>
                </div>
            </div>

            <!-- Strategy Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üéØ Your Strategy: Threshold Exit</div>
                </div>
                <p style="font-size: 13px; color: var(--text-dim); margin-bottom: 16px;">
                    Trade swings within the 15-min window. Don't hold to resolution. 
                    Enter when market misprices, exit at target profit.
                </p>
                <div class="threshold-list" id="thresholdList">
                    <div class="threshold-item" data-threshold="entry-low">
                        <div>
                            <div class="threshold-name">üì• Entry Zone (Buy UP)</div>
                            <div style="font-size: 12px; color: var(--text-dim);">When UP price drops below this</div>
                        </div>
                        <div class="threshold-value" style="color: var(--green);">‚â§ 0.45</div>
                    </div>
                    <div class="threshold-item" data-threshold="entry-high">
                        <div>
                            <div class="threshold-name">üì• Entry Zone (Buy DOWN)</div>
                            <div style="font-size: 12px; color: var(--text-dim);">When UP price rises above this</div>
                        </div>
                        <div class="threshold-value" style="color: var(--red);">‚â• 0.55</div>
                    </div>
                    <div class="threshold-item" data-threshold="profit-target">
                        <div>
                            <div class="threshold-name">üí∞ Profit Target</div>
                            <div style="font-size: 12px; color: var(--text-dim);">Exit when you hit this gain</div>
                        </div>
                        <div class="threshold-value">3%</div>
                    </div>
                    <div class="threshold-item" data-threshold="stop-loss">
                        <div>
                            <div class="threshold-name">üõë Stop Loss</div>
                            <div style="font-size: 12px; color: var(--text-dim);">Exit to limit losses</div>
                        </div>
                        <div class="threshold-value" style="color: var(--red);">-2%</div>
                    </div>
                    <div class="threshold-item" data-threshold="time-exit">
                        <div>
                            <div class="threshold-name">‚è±Ô∏è Time Exit</div>
                            <div style="font-size: 12px; color: var(--text-dim);">Exit before resolution risk</div>
                        </div>
                        <div class="threshold-value">< 2 min left</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <!-- Key Metrics -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìä Window Stats</div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">Price Range (this window)</div>
                    <div class="insight-value">
                        <span id="priceHigh" style="color: var(--green);">--</span> / 
                        <span id="priceLow" style="color: var(--red);">--</span>
                    </div>
                    <div class="insight-detail">High / Low</div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">Price Volatility</div>
                    <div class="insight-value" id="volatility">--%</div>
                    <div class="insight-detail">Standard deviation of returns</div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">Updates Received</div>
                    <div class="insight-value" id="updateCount">0</div>
                    <div class="insight-detail">Price changes this window</div>
                </div>
            </div>

            <!-- Market Selection Info -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">‚ÑπÔ∏è About This Market</div>
                </div>
                <div style="font-size: 13px; line-height: 1.6;">
                    <p style="margin-bottom: 12px;">
                        <strong>Resolution:</strong> UP wins if BTC price at window end ‚â• start price.
                    </p>
                    <p style="margin-bottom: 12px;">
                        <strong>Your Edge:</strong> Market often overreacts to short-term moves. 
                        Buy when price swings too far, sell when it reverts.
                    </p>
                    <p style="color: var(--text-dim);">
                        <strong>Costs:</strong> ~1% spread + 0.1% taker fee = ~1.1% round trip
                    </p>
                </div>
            </div>

            <!-- Recent Price Changes -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üîÑ Recent Price Changes</div>
                </div>
                <div id="recentChanges" style="font-family: 'IBM Plex Mono', monospace; font-size: 12px;">
                    <div style="color: var(--text-dim); text-align: center; padding: 20px;">
                        Waiting for updates...
                    </div>
                </div>
            </div>

            <!-- Strategy Comparison -->
            <div class="card" id="strategyCard">
                <div class="card-header">
                    <div class="card-title">üìä Strategy Comparison ($100/trade)</div>
                </div>
                <div id="strategyComparison">
                    <div style="color: var(--text-dim); text-align: center; padding: 20px;">
                        Waiting for strategy data...
                    </div>
                </div>
            </div>

            <!-- Active Trades -->
            <div class="card" id="tradesCard">
                <div class="card-header">
                    <div class="card-title">üîÑ Open Positions</div>
                    <span class="mono" id="openCount" style="color: var(--blue);">0</span>
                </div>
                <div id="openPositions">
                    <div style="color: var(--text-dim); text-align: center; padding: 20px;">
                        No open positions
                    </div>
                </div>
            </div>

            <!-- Session P&L -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üí∞ Session P&L</div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="insight-card">
                        <div class="insight-title">Total P&L</div>
                        <div class="insight-value" id="totalPnl" style="color: var(--text);">$0.00</div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-title">Win Rate</div>
                        <div class="insight-value" id="winRate">0%</div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-title">Total Trades</div>
                        <div class="insight-value" id="totalTrades">0</div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-title">Best Strategy</div>
                        <div class="insight-value" id="bestStrategy" style="font-size: 14px;">--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div> <!-- End tradingView -->

    <script>
        // State
        let currentCrypto = 'BTC';
        let currentView = 'trading';
        let marketData = { BTC: null, ETH: null, SOL: null, XRP: null };
        let priceHistory = { BTC: [], ETH: [], SOL: [], XRP: [] };
        let updateCount = 0;
        let isConnected = false;
        let pollInterval = null;

        // Poll API for data (Vercel doesn't support WebSockets)
        async function fetchTicks() {
            try {
                const cryptos = ['btc', 'eth', 'sol', 'xrp'];
                const promises = cryptos.map(c => 
                    fetch(`/api/ticks?crypto=${c}&limit=1`).then(r => r.json())
                );
                
                const results = await Promise.all(promises);
                
                results.forEach((result, i) => {
                    if (result.ticks && result.ticks.length > 0) {
                        const tick = result.ticks[0];
                        // Convert to expected format
                        const formattedTick = {
                            crypto: cryptos[i].toUpperCase(),
                            timestamp: tick.timestamp,
                            epoch: tick.window_epoch,
                            time_remaining_sec: parseFloat(tick.time_remaining_sec) || 0,
                            up_bid: parseFloat(tick.up_bid),
                            up_ask: parseFloat(tick.up_ask),
                            up_mid: parseFloat(tick.up_mid),
                            down_bid: parseFloat(tick.down_bid),
                            down_ask: parseFloat(tick.down_ask),
                            down_mid: parseFloat(tick.down_mid) || (1 - parseFloat(tick.up_mid)),
                            spot_price: parseFloat(tick.spot_price),
                            price_to_beat: parseFloat(tick.price_to_beat),
                            spot_delta_pct: parseFloat(tick.spot_delta_pct),
                            spread: parseFloat(tick.spread),
                            spread_pct: parseFloat(tick.spread_pct)
                        };
                        handleTick(formattedTick);
                    }
                });
                
                if (!isConnected) {
                    isConnected = true;
                    document.getElementById('statusDot').style.background = 'var(--green)';
                    document.getElementById('statusText').textContent = 'Live';
                }
            } catch (e) {
                console.error('Fetch error:', e);
                isConnected = false;
                document.getElementById('statusDot').style.background = 'var(--red)';
                document.getElementById('statusText').textContent = 'Disconnected';
            }
        }

        // Start polling
        function connect() {
            document.getElementById('statusText').textContent = 'Connecting...';
            fetchTicks(); // Initial fetch
            pollInterval = setInterval(fetchTicks, 3000); // Poll every 3 seconds
        }
        
        // Strategy comparison data
        let strategyData = {};
        
        function handleStrategyComparison(comparison) {
            strategyData = comparison;
            updateStrategyDisplay();
        }
        
        function handleMetrics(metrics) {
            // Update session P&L
            if (metrics.totalPnl !== undefined) {
                const pnlEl = document.getElementById('totalPnl');
                const pnl = metrics.totalPnl;
                pnlEl.textContent = `${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}`;
                pnlEl.style.color = pnl >= 0 ? 'var(--green)' : 'var(--red)';
            }
            
            if (metrics.totalTrades !== undefined) {
                document.getElementById('totalTrades').textContent = metrics.totalTrades;
            }
            
            if (metrics.winRate !== undefined) {
                document.getElementById('winRate').textContent = `${(metrics.winRate * 100).toFixed(0)}%`;
            }
            
            if (metrics.openPositions !== undefined) {
                document.getElementById('openCount').textContent = metrics.openPositions;
            }
        }
        
        function handleTradeExecution(execution) {
            // Could show toast notification for trade entries/exits
            console.log('Trade execution:', execution);
        }
        
        function updateStrategyDisplay() {
            const container = document.getElementById('strategyComparison');
            
            if (!strategyData || Object.keys(strategyData).length === 0) {
                container.innerHTML = '<div style="color: var(--text-dim); text-align: center; padding: 20px;">No strategy data yet</div>';
                return;
            }
            
            let html = '';
            let bestPnl = -Infinity;
            let bestName = '--';
            
            for (const [name, data] of Object.entries(strategyData)) {
                const metrics = data.tradeMetrics || {};
                const signals = data.signalStats || {};
                
                const pnl = metrics.netPnl || 0;
                const trades = metrics.tradeCount || 0;
                const winRate = metrics.winRate || 0;
                
                if (pnl > bestPnl && trades > 0) {
                    bestPnl = pnl;
                    bestName = name;
                }
                
                const pnlColor = pnl >= 0 ? 'var(--green)' : 'var(--red)';
                const pnlStr = `${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}`;
                
                html += `
                    <div style="background: var(--bg-highlight); border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; font-size: 13px;">${name}</span>
                            <span class="mono" style="color: ${pnlColor}; font-weight: 600;">${pnlStr}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; font-size: 11px;">
                            <div>
                                <div style="color: var(--text-dim);">Trades</div>
                                <div class="mono">${trades}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-dim);">Win Rate</div>
                                <div class="mono">${(winRate * 100).toFixed(0)}%</div>
                            </div>
                            <div>
                                <div style="color: var(--text-dim);">Signals</div>
                                <div class="mono">${signals.totalSignals || 0}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            document.getElementById('bestStrategy').textContent = bestName;
        }

        function handleTick(tick) {
            const crypto = tick.crypto;
            marketData[crypto] = tick;
            
            // Track price history
            if (tick.up_mid && tick.up_mid !== 0.5) {
                priceHistory[crypto].push({
                    time: tick.timestamp,
                    price: tick.up_mid,
                    spot: tick.spot_price
                });
                // Keep last 100
                if (priceHistory[crypto].length > 100) {
                    priceHistory[crypto].shift();
                }
            }

            // Update tab states
            updateTabs();
            
            // Update display if this is the selected crypto
            if (crypto === currentCrypto) {
                updateDisplay(tick);
            }
        }

        function updateTabs() {
            document.querySelectorAll('.market-tab').forEach(tab => {
                const crypto = tab.dataset.crypto;
                const data = marketData[crypto];
                
                if (data && data.up_mid && data.up_mid !== 0.5) {
                    tab.classList.remove('inactive');
                } else {
                    if (crypto !== currentCrypto) {
                        tab.classList.add('inactive');
                    }
                }
            });
        }

        function updateDisplay(tick) {
            updateCount++;
            
            // Time remaining
            const mins = Math.floor(tick.time_remaining_sec / 60);
            const secs = tick.time_remaining_sec % 60;
            document.getElementById('timeRemaining').textContent = 
                `${mins}:${secs.toString().padStart(2, '0')}`;
            
            // Window epoch
            document.getElementById('windowEpoch').textContent = tick.epoch || '--';
            
            // Prices
            const hasRealData = tick.up_mid && tick.up_mid !== 0.5;
            
            if (hasRealData) {
                // UP price
                const upEl = document.getElementById('upPrice');
                upEl.textContent = tick.up_mid.toFixed(4);
                flashElement(upEl);
                
                // DOWN price
                const downEl = document.getElementById('downPrice');
                downEl.textContent = tick.down_mid.toFixed(4);
                
                // Bid/Ask
                if (tick.up_bid && tick.up_ask) {
                    document.getElementById('upBidAsk').textContent = 
                        `${tick.up_bid.toFixed(2)} / ${tick.up_ask.toFixed(2)}`;
                }
                
                // Spread
                const spread = tick.spread || (tick.up_ask - tick.up_bid) || 0;
                document.getElementById('spread').textContent = 
                    `${(spread * 100).toFixed(1)}%`;
                
                // Market implied
                document.getElementById('marketImplied').textContent = 
                    `${(tick.up_mid * 100).toFixed(0)}% up`;
            } else {
                document.getElementById('upPrice').textContent = 'No data';
                document.getElementById('downPrice').textContent = 'No data';
                document.getElementById('upBidAsk').textContent = '-- / --';
                document.getElementById('spread').textContent = '--%';
                document.getElementById('marketImplied').textContent = 'Unknown';
            }
            
            // Spot price
            if (tick.spot_price) {
                const spotEl = document.getElementById('spotPrice');
                // Format based on crypto (XRP needs more decimals)
                const decimals = currentCrypto === 'XRP' ? 4 : 2;
                spotEl.textContent = `$${tick.spot_price.toLocaleString(undefined, {minimumFractionDigits: decimals, maximumFractionDigits: decimals})}`;
                flashElement(spotEl);
            }
            
            // Price to beat
            const ptb = tick.price_to_beat || tick.window_start_price;
            if (ptb) {
                const decimals = currentCrypto === 'XRP' ? 4 : 2;
                document.getElementById('priceToBeat').textContent = 
                    `$${ptb.toLocaleString(undefined, {minimumFractionDigits: decimals, maximumFractionDigits: decimals})}`;
            }
            
            // Spot delta
            if (tick.spot_delta_pct !== undefined && tick.spot_delta_pct !== 0) {
                const delta = tick.spot_delta_pct * 100;
                const deltaEl = document.getElementById('spotDelta');
                deltaEl.textContent = `${delta >= 0 ? '+' : ''}${delta.toFixed(3)}%`;
                deltaEl.style.color = delta >= 0 ? 'var(--green)' : 'var(--red)';
            } else if (tick.spot_price && ptb) {
                // Calculate it ourselves
                const delta = ((tick.spot_price - ptb) / ptb) * 100;
                const deltaEl = document.getElementById('spotDelta');
                deltaEl.textContent = `${delta >= 0 ? '+' : ''}${delta.toFixed(3)}%`;
                deltaEl.style.color = delta >= 0 ? 'var(--green)' : 'var(--red)';
            }
            
            // Implied direction
            const dirEl = document.getElementById('impliedDirection');
            if (tick.implied_direction) {
                dirEl.textContent = tick.implied_direction === 'up' ? 'üìà UP (Spot ‚â• PTB)' : 'üìâ DOWN (Spot < PTB)';
                dirEl.style.color = tick.implied_direction === 'up' ? 'var(--green)' : 'var(--red)';
            } else if (tick.spot_price && ptb) {
                const isUp = tick.spot_price >= ptb;
                dirEl.textContent = isUp ? 'üìà UP (Spot ‚â• PTB)' : 'üìâ DOWN (Spot < PTB)';
                dirEl.style.color = isUp ? 'var(--green)' : 'var(--red)';
            }
            
            // Correlation insight
            updateCorrelationInsight(tick);
            
            // Trade signal
            updateSignal(tick);
            
            // Stats
            updateStats(tick.crypto);
            
            // Recent changes
            addRecentChange(tick);
            
            // Update count
            document.getElementById('updateCount').textContent = updateCount;
        }

        function updateCorrelationInsight(tick) {
            const el = document.getElementById('correlationInsight');
            
            if (!tick.spot_delta_pct && (!tick.spot_price || !tick.window_start_price)) {
                el.textContent = 'Waiting for spot data...';
                el.style.color = 'var(--text-dim)';
                return;
            }
            
            const spotDelta = tick.spot_delta_pct || 
                ((tick.spot_price - tick.window_start_price) / tick.window_start_price);
            const marketImplied = tick.up_mid || 0.5;
            
            // Is spot up but market hasn't caught up?
            if (spotDelta > 0.001 && marketImplied < 0.55) {
                el.innerHTML = 'üî• <strong>Potential opportunity:</strong> Spot is UP but market hasn\'t fully priced it in';
                el.style.color = 'var(--green)';
            } else if (spotDelta < -0.001 && marketImplied > 0.45) {
                el.innerHTML = 'üî• <strong>Potential opportunity:</strong> Spot is DOWN but market hasn\'t fully priced it in';
                el.style.color = 'var(--red)';
            } else if (Math.abs(spotDelta) < 0.0005) {
                el.innerHTML = '‚öñÔ∏è Spot is flat - market is uncertain (50/50)';
                el.style.color = 'var(--text-dim)';
            } else {
                el.innerHTML = '‚úì Market appears fairly priced relative to spot movement';
                el.style.color = 'var(--text-dim)';
            }
        }

        function updateSignal(tick) {
            const signalBox = document.getElementById('signalBox');
            const signalText = document.getElementById('signalText');
            const signalReason = document.getElementById('signalReason');
            
            const hasRealData = tick.up_mid && tick.up_mid !== 0.5;
            const timeLeft = tick.time_remaining_sec;
            
            if (!hasRealData) {
                signalBox.className = 'signal-box wait';
                signalText.textContent = 'NO DATA';
                signalReason.textContent = 'Waiting for Polymarket price data';
                return;
            }
            
            const upPrice = tick.up_mid;
            const spread = tick.spread || 0.01;
            
            // Time-based exit warning
            if (timeLeft < 120) {
                signalBox.className = 'signal-box caution';
                signalText.textContent = '‚ö†Ô∏è EXIT ZONE';
                signalReason.textContent = `Only ${Math.floor(timeLeft/60)}:${(timeLeft%60).toString().padStart(2,'0')} left - resolution risk too high`;
                return;
            }
            
            // Entry opportunities
            if (upPrice <= 0.45) {
                signalBox.className = 'signal-box opportunity';
                signalText.textContent = 'üìà BUY UP';
                signalReason.textContent = `UP at ${upPrice.toFixed(2)} - below entry threshold. Target: ${(upPrice + 0.03).toFixed(2)}`;
                highlightThreshold('entry-low');
            } else if (upPrice >= 0.55) {
                signalBox.className = 'signal-box opportunity';
                signalText.textContent = 'üìâ BUY DOWN';
                signalReason.textContent = `UP at ${upPrice.toFixed(2)} - above entry threshold. Target: ${(upPrice - 0.03).toFixed(2)}`;
                highlightThreshold('entry-high');
            } else if (spread > 0.02) {
                signalBox.className = 'signal-box caution';
                signalText.textContent = '‚ö†Ô∏è HIGH SPREAD';
                signalReason.textContent = `Spread is ${(spread*100).toFixed(1)}% - wait for tighter market`;
            } else {
                signalBox.className = 'signal-box wait';
                signalText.textContent = 'üëÄ WATCHING';
                signalReason.textContent = `UP at ${upPrice.toFixed(2)} - waiting for entry at ‚â§0.45 or ‚â•0.55`;
                clearThresholdHighlights();
            }
        }

        function highlightThreshold(id) {
            clearThresholdHighlights();
            const item = document.querySelector(`[data-threshold="${id}"]`);
            if (item) item.classList.add('active');
        }

        function clearThresholdHighlights() {
            document.querySelectorAll('.threshold-item').forEach(el => el.classList.remove('active'));
        }

        function updateStats(crypto) {
            const history = priceHistory[crypto];
            if (history.length < 2) return;
            
            const prices = history.map(h => h.price);
            const high = Math.max(...prices);
            const low = Math.min(...prices);
            
            document.getElementById('priceHigh').textContent = high.toFixed(4);
            document.getElementById('priceLow').textContent = low.toFixed(4);
            
            // Volatility (std dev of returns)
            const returns = [];
            for (let i = 1; i < prices.length; i++) {
                returns.push((prices[i] - prices[i-1]) / prices[i-1]);
            }
            if (returns.length > 1) {
                const mean = returns.reduce((a,b) => a+b, 0) / returns.length;
                const variance = returns.reduce((sum, r) => sum + Math.pow(r - mean, 2), 0) / returns.length;
                const std = Math.sqrt(variance);
                document.getElementById('volatility').textContent = `${(std * 100).toFixed(2)}%`;
            }
        }

        function addRecentChange(tick) {
            if (!tick.up_mid || tick.up_mid === 0.5) return;
            
            const container = document.getElementById('recentChanges');
            const time = new Date(tick.timestamp).toLocaleTimeString();
            
            const html = `<div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border);">
                <span style="color: var(--text-dim)">${time}</span>
                <span style="color: var(--green)">${tick.up_mid.toFixed(4)}</span>
                <span style="color: var(--text-dim)">$${tick.spot_price?.toLocaleString(undefined, {maximumFractionDigits: 0}) || '--'}</span>
            </div>`;
            
            // Keep last 10
            const items = container.querySelectorAll('div');
            if (items.length >= 10) {
                container.removeChild(container.lastChild);
            }
            container.insertAdjacentHTML('afterbegin', html);
        }

        function flashElement(el) {
            el.classList.add('flash');
            setTimeout(() => el.classList.remove('flash'), 200);
        }

        // Tab switching
        document.querySelectorAll('.market-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                currentCrypto = tab.dataset.crypto;
                document.querySelectorAll('.market-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Update market name
                const names = { BTC: 'Bitcoin', ETH: 'Ethereum', SOL: 'Solana', XRP: 'XRP' };
                document.getElementById('marketName').textContent = `${names[currentCrypto]} Up/Down`;
                
                // Clear and refresh
                document.getElementById('recentChanges').innerHTML = 
                    '<div style="color: var(--text-dim); text-align: center; padding: 20px;">Waiting for updates...</div>';
                
                if (marketData[currentCrypto]) {
                    updateDisplay(marketData[currentCrypto]);
                }
            });
        });

        // Update server time
        setInterval(() => {
            document.getElementById('serverTime').textContent = new Date().toLocaleTimeString();
        }, 1000);

        // View switching
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.view === view);
            });
            document.getElementById('tradingView').style.display = view === 'trading' ? 'block' : 'none';
            document.getElementById('researchView').style.display = view === 'research' ? 'block' : 'none';
            
            if (view === 'research') {
                refreshResearch();
            }
        }

        // Research data loading
        async function refreshResearch() {
            try {
                document.getElementById('researchStatus').textContent = 'Loading...';
                
                // Fetch all research data in parallel
                const [summary, efficiency, volatility, spotlag, strategies] = await Promise.all([
                    fetch('/api/research').then(r => r.json()),
                    fetch('/api/research?type=efficiency').then(r => r.json()),
                    fetch('/api/research?type=volatility').then(r => r.json()),
                    fetch('/api/research?type=spotlag').then(r => r.json()),
                    fetch('/api/research?type=strategies').then(r => r.json())
                ]);

                const now = new Date().toLocaleTimeString();
                document.getElementById('researchStatus').textContent = `Last updated: ${now}`;

                // Update header stats
                document.getElementById('researchTicks').textContent = summary.ticksLastHour?.toLocaleString() || '0';
                document.getElementById('researchWindows').textContent = summary.totalWindows?.toLocaleString() || '0';
                
                // Update from research stats if available
                const stats = summary.researchStats || strategies.data;
                if (stats) {
                    if (stats.efficiency?.meanAbsEdgePct) {
                        document.getElementById('researchAvgEdge').textContent = `${stats.efficiency.meanAbsEdgePct.toFixed(2)}%`;
                    }
                    if (stats.spotLag?.avgHalfPricingTimeMs) {
                        document.getElementById('researchSpotLag').textContent = `${Math.round(stats.spotLag.avgHalfPricingTimeMs)}ms`;
                    }
                }

                // Strategy Performance Leaderboard
                if (stats && stats.strategies && stats.strategies.length > 0) {
                    const sorted = [...stats.strategies].sort((a, b) => b.totalPnl - a.totalPnl);
                    const leaderboardHtml = `
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr style="border-bottom: 2px solid var(--border); text-align: left;">
                                    <th style="padding: 10px 8px;">#</th>
                                    <th style="padding: 10px 8px;">Strategy</th>
                                    <th style="padding: 10px 8px; text-align: right;">Signals</th>
                                    <th style="padding: 10px 8px; text-align: right;">Trades</th>
                                    <th style="padding: 10px 8px; text-align: right;">Win Rate</th>
                                    <th style="padding: 10px 8px; text-align: right;">P&L</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sorted.map((s, i) => {
                                    const winRate = s.trades > 0 ? ((s.wins / s.trades) * 100).toFixed(0) : '--';
                                    const pnlColor = s.totalPnl > 0 ? 'var(--green)' : s.totalPnl < 0 ? 'var(--red)' : 'var(--text)';
                                    const rowBg = i === 0 && s.totalPnl > 0 ? 'var(--green-dim)' : 'transparent';
                                    return `
                                        <tr style="border-bottom: 1px solid var(--border); background: ${rowBg};">
                                            <td style="padding: 10px 8px; color: var(--text-dim);">${i + 1}</td>
                                            <td style="padding: 10px 8px; font-weight: 500;">${s.name}</td>
                                            <td style="padding: 10px 8px; text-align: right;">${s.signals || 0}</td>
                                            <td style="padding: 10px 8px; text-align: right;">${s.trades || 0}</td>
                                            <td style="padding: 10px 8px; text-align: right;">${winRate}%</td>
                                            <td style="padding: 10px 8px; text-align: right; font-weight: 600; color: ${pnlColor};">
                                                ${s.totalPnl >= 0 ? '+' : ''}$${s.totalPnl?.toFixed(2) || '0.00'}
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                    document.getElementById('strategyLeaderboard').innerHTML = leaderboardHtml;
                } else {
                    document.getElementById('strategyLeaderboard').innerHTML = `
                        <div style="color: var(--text-dim); padding: 40px; text-align: center;">
                            <div style="font-size: 14px; margin-bottom: 8px;">No strategy data yet</div>
                            <div style="font-size: 12px;">Railway collector saves stats every 60 seconds. Check Railway logs for status.</div>
                        </div>
                    `;
                }

                // Update crypto states with more detail
                if (summary.latestByProto && summary.latestByProto.length > 0) {
                    const statesHtml = summary.latestByProto.map(s => {
                        const upMid = parseFloat(s.up_mid);
                        const spreadCents = (parseFloat(s.spread_pct) / 100 * upMid * 100).toFixed(1);
                        return `
                            <div class="insight-card">
                                <div class="insight-title">${s.crypto.toUpperCase()}</div>
                                <div class="insight-value" style="font-size: 24px; color: ${upMid > 0.5 ? 'var(--green)' : 'var(--red)'}">
                                    ${(upMid * 100).toFixed(1)}%
                                </div>
                                <div style="font-size: 12px; color: var(--text-dim); margin-top: 4px;">
                                    Spread: ${spreadCents}¬¢ (${parseFloat(s.spread_pct).toFixed(1)}%)
                                </div>
                                <div style="font-size: 12px; color: var(--text-dim);">
                                    ${Math.round(parseFloat(s.time_remaining_sec))}s remaining
                                </div>
                            </div>
                        `;
                    }).join('');
                    document.getElementById('cryptoStates').innerHTML = statesHtml;
                }

                // Fair Value Analysis (use efficiency data)
                if (efficiency.data && efficiency.data.length > 0) {
                    const fvHtml = efficiency.data.map(e => {
                        const avgUp = parseFloat(e.avg_up_mid);
                        const stdDev = parseFloat(e.stddev_up_mid || 0);
                        const spread = parseFloat(e.avg_spread_pct || 0);
                        // Insight: high stddev = market uncertainty
                        const uncertaintyLevel = stdDev > 0.25 ? 'High' : stdDev > 0.15 ? 'Medium' : 'Low';
                        return `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border);">
                                <span style="font-weight: 600; width: 50px;">${e.crypto.toUpperCase()}</span>
                                <span style="color: ${avgUp > 0.5 ? 'var(--green)' : 'var(--red)'};">${(avgUp * 100).toFixed(1)}% avg</span>
                                <span>¬±${(stdDev * 100).toFixed(1)}%</span>
                                <span style="font-size: 11px; padding: 2px 6px; border-radius: 4px; background: ${uncertaintyLevel === 'High' ? 'var(--red-dim)' : uncertaintyLevel === 'Medium' ? 'var(--yellow-dim)' : 'var(--green-dim)'};">
                                    ${uncertaintyLevel} uncertainty
                                </span>
                            </div>
                        `;
                    }).join('');
                    document.getElementById('fairValueAnalysis').innerHTML = fvHtml;
                }

                // Edge by Phase (mock for now - would need backend to calculate)
                document.getElementById('edgeByPhase').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                        <div style="padding: 16px; background: var(--bg-highlight); border-radius: 8px;">
                            <div style="font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">EARLY (0-5min)</div>
                            <div style="font-size: 18px; font-weight: 600; color: var(--yellow);">~5%</div>
                            <div style="font-size: 11px; color: var(--text-dim);">Higher edge, less certainty</div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-highlight); border-radius: 8px;">
                            <div style="font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">MID (5-12min)</div>
                            <div style="font-size: 18px; font-weight: 600; color: var(--green);">~3%</div>
                            <div style="font-size: 11px; color: var(--text-dim);">Optimal zone</div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-highlight); border-radius: 8px;">
                            <div style="font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">LATE (12-15min)</div>
                            <div style="font-size: 18px; font-weight: 600; color: var(--blue);">~8%</div>
                            <div style="font-size: 11px; color: var(--text-dim);">Wide spreads, big swings</div>
                        </div>
                    </div>
                `;

                // Update volatility data
                if (volatility.data && volatility.data.length > 0) {
                    const volHtml = volatility.data.map(v => {
                        const priceVol = parseFloat(v.price_vol || 0) * 100;
                        const spotVol = parseFloat(v.spot_vol || 0) * 100;
                        const ratio = spotVol > 0 ? (priceVol / spotVol).toFixed(1) : '--';
                        return `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border);">
                                <span style="font-weight: 600; width: 50px;">${v.crypto.toUpperCase()}</span>
                                <span>Market: ${priceVol.toFixed(2)}%</span>
                                <span>Spot: ${spotVol.toFixed(4)}%</span>
                                <span style="color: var(--blue);">${ratio}x leverage</span>
                            </div>
                        `;
                    }).join('');
                    document.getElementById('volatilityData').innerHTML = volHtml;
                }

                // Update spot lag data
                if (spotlag.data && spotlag.data.length > 0) {
                    const lagHtml = spotlag.data.map(l => {
                        const moves = parseInt(l.move_count);
                        const spotChange = parseFloat(l.avg_abs_spot_change || 0) * 100;
                        const marketResp = parseFloat(l.avg_abs_market_response || 0) * 100;
                        const efficiency = spotChange > 0 ? (marketResp / spotChange).toFixed(1) : '--';
                        return `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border);">
                                <span style="font-weight: 600; width: 50px;">${l.crypto.toUpperCase()}</span>
                                <span>${moves} moves</span>
                                <span>Spot Œî: ${spotChange.toFixed(3)}%</span>
                                <span>Mkt resp: ${marketResp.toFixed(2)}%</span>
                            </div>
                        `;
                    }).join('');
                    document.getElementById('spotLagData').innerHTML = lagHtml;
                }

                // Generate Quant Insights
                generateInsights(summary, efficiency, volatility, spotlag, stats);

            } catch (error) {
                console.error('Research data error:', error);
                document.getElementById('researchStatus').textContent = `Error: ${error.message}`;
            }
        }

        // Generate quantitative insights based on the data
        function generateInsights(summary, efficiency, volatility, spotlag, stats) {
            const insights = [];

            // Insight from volatility
            if (volatility.data) {
                const maxVol = volatility.data.reduce((max, v) => 
                    parseFloat(v.price_vol || 0) > parseFloat(max.price_vol || 0) ? v : max, {price_vol: 0});
                if (maxVol.crypto) {
                    insights.push({
                        icon: 'üìä',
                        text: `<strong>${maxVol.crypto.toUpperCase()}</strong> has the highest price volatility (${(parseFloat(maxVol.price_vol)*100).toFixed(2)}%). Higher vol = more profit potential but also more risk.`
                    });
                }
            }

            // Insight from efficiency
            if (efficiency.data) {
                const widestSpread = efficiency.data.reduce((max, e) => 
                    parseFloat(e.avg_spread_pct || 0) > parseFloat(max.avg_spread_pct || 0) ? e : max, {avg_spread_pct: 0});
                if (widestSpread.crypto && parseFloat(widestSpread.avg_spread_pct) > 5) {
                    insights.push({
                        icon: '‚ö†Ô∏è',
                        text: `<strong>${widestSpread.crypto.toUpperCase()}</strong> has wide spreads (${parseFloat(widestSpread.avg_spread_pct).toFixed(1)}%). Market makers are pricing in high uncertainty.`
                    });
                }
            }

            // Insight from spot lag
            if (spotlag.data && spotlag.data.length > 0) {
                const totalMoves = spotlag.data.reduce((sum, l) => sum + parseInt(l.move_count || 0), 0);
                if (totalMoves > 0) {
                    insights.push({
                        icon: '‚ö°',
                        text: `Detected <strong>${totalMoves}</strong> significant spot moves in the last hour. The market may be lagging - potential alpha in fast execution.`
                    });
                }
            }

            // Insight from strategy performance
            if (stats && stats.topStrategy) {
                const top = stats.topStrategy;
                if (top.trades > 0) {
                    insights.push({
                        icon: 'üèÜ',
                        text: `Top strategy is <strong>${top.name}</strong> with ${(top.winRate * 100).toFixed(0)}% win rate and $${top.pnl.toFixed(2)} P&L from ${top.trades} trades.`
                    });
                }
            }

            // Insight about ticks
            if (summary.ticksLastHour > 10000) {
                insights.push({
                    icon: '‚úÖ',
                    text: `Strong data flow: <strong>${summary.ticksLastHour.toLocaleString()}</strong> ticks/hour. Good sample size for strategy evaluation.`
                });
            }

            // Default insight
            if (insights.length === 0) {
                insights.push({
                    icon: 'üìà',
                    text: 'Collecting data and calibrating models. Insights will appear as patterns emerge.'
                });
            }

            const insightsHtml = insights.map(i => `
                <div style="display: flex; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border);">
                    <span style="font-size: 18px;">${i.icon}</span>
                    <span>${i.text}</span>
                </div>
            `).join('');

            document.getElementById('quantInsights').innerHTML = insightsHtml;
        }

        // Connect
        connect();
    </script>
</body>
</html>
